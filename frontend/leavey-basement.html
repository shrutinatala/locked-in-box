<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Leavey Basement</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        text-align: center;
        margin: 0;
        padding: 0;
      }

      h1 {
        margin-top: 30px;
      }

      #tables-container {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        max-width: 800px;
        margin: 20px auto;
      }

      .table-box {
        width: 140px;
        min-height: 100px;
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        align-items: center;
        border-radius: 8px;
        cursor: pointer;
        transition: background-color 0.5s;
        font-weight: bold;
        text-align: center;
        padding: 10px;
        box-sizing: border-box;
      }

      #progress-container {
        width: 80%;
        height: 25px;
        background-color: #ddd;
        border-radius: 12px;
        margin: 20px auto;
        overflow: hidden;
      }

      #progress-bar {
        height: 100%;
        width: 0%;
        background-color: #4caf50;
        border-radius: 12px;
        transition: width 0.5s ease, background-color 0.5s ease;
      }

      #progress-wrapper {
        width: 80%;
        margin: 20px auto;
        text-align: center;
      }

      #progress-text {
        margin-top: 5px;
        font-weight: bold;
        font-size: 16px;
      }

      #table-1-names {
        margin-top: 10px;
        font-size: 12px;
        font-weight: normal;
        line-height: 1.2;
      }

      #table-1-names p {
        margin: 2px 0;
      }

      #debug-info {
        position: fixed;
        top: 10px;
        right: 10px;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 10px;
        border-radius: 5px;
        font-size: 12px;
        max-width: 300px;
      }
    </style>
  </head>
  <body>
    <p><a href="leavey.html">‚Üê Back to Leavey Floors</a></p>
    <h1>Leavey Basement</h1>

    <div id="progress-wrapper">
      <div id="progress-container">
        <div id="progress-bar"></div>
      </div>
      <div id="progress-text">0% Occupancy</div>
    </div>

    <div id="tables-container"></div>

    <!-- Debug info panel -->
    <div id="debug-info">
      <div>
        Firebase Status: <span id="firebase-status">Connecting...</span>
      </div>
      <div>Table 1 Count: <span id="table1-count">0</span></div>
      <div>Last Update: <span id="last-update">Never</span></div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
      import {
        getFirestore,
        collection,
        query,
        orderBy,
        onSnapshot,
      } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";

      // Your web app's Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyClE7hLUOvw2zni2Xv3D2jy2tsGfWnafm4",
        authDomain: "locked-in-box.firebaseapp.com",
        projectId: "locked-in-box",
        storageBucket: "locked-in-box.firebasestorage.app",
        messagingSenderId: "624013844525",
        appId: "1:624013844525:web:452a00797d5d62caa298a4",
        measurementId: "G-M2NNFKYJFL",
      };

      let app, db;
      try {
        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        document.getElementById("firebase-status").textContent = "Connected";
        console.log("‚úÖ Firebase initialized successfully");
      } catch (error) {
        console.error("‚ùå Firebase initialization failed:", error);
        document.getElementById("firebase-status").textContent = "Failed";
      }

      const tablesContainer = document.getElementById("tables-container");
      const progressBar = document.getElementById("progress-bar");
      const progressText = document.getElementById("progress-text");

      const TOTAL_TABLES = 10;
      const MAX_OCCUPANCY = 4;
      const MAX_CAPACITY = TOTAL_TABLES * MAX_OCCUPANCY;

      let tableData = {};

      const gradientStops = [
        { pct: 0, color: "lightgreen" },
        { pct: 25, color: "#d9f542" },
        { pct: 50, color: "#f5d742" },
        { pct: 75, color: "#f59e42" },
        { pct: 100, color: "#f54242" },
      ];

      function lerpColor(a, b, t) {
        const ah = parseInt(a.replace(/#/g, ""), 16),
          ar = ah >> 16,
          ag = (ah >> 8) & 0xff,
          ab = ah & 0xff;
        const bh = parseInt(b.replace(/#/g, ""), 16),
          br = bh >> 16,
          bg = (bh >> 8) & 0xff,
          bb = bh & 0xff;
        const rr = ar + t * (br - ar),
          rg = ag + t * (bg - ag),
          rb = ab + t * (bb - ab);
        return (
          "#" +
          (
            (1 << 24) +
            (Math.round(rr) << 16) +
            (Math.round(rg) << 8) +
            Math.round(rb)
          )
            .toString(16)
            .slice(1)
        );
      }

      function getGradientColor(pct) {
        let lower = gradientStops[0],
          upper = gradientStops[gradientStops.length - 1];
        for (let i = 0; i < gradientStops.length - 1; i++) {
          if (pct >= gradientStops[i].pct && pct <= gradientStops[i + 1].pct) {
            lower = gradientStops[i];
            upper = gradientStops[i + 1];
            break;
          }
        }
        const range = upper.pct - lower.pct;
        const t = (pct - lower.pct) / range;
        return lerpColor(lower.color, upper.color, t);
      }

      // Create tables
      for (let i = 1; i <= TOTAL_TABLES; i++) {
        tableData[i] = 0;
        const div = document.createElement("div");
        div.classList.add("table-box");
        div.id = `table-${i}`;

        if (i === 1) {
          // Table 1: Firebase-driven
          const header = document.createElement("div");
          header.id = "table-1-header";
          header.innerHTML = `<strong>Table 1</strong><br>Occupancy: <span id="table-1-occupancy">0</span>/${MAX_OCCUPANCY}`;
          div.appendChild(header);

          const namesContainer = document.createElement("div");
          namesContainer.id = "table-1-names";
          div.appendChild(namesContainer);

          // Listen to Firestore subcollection
          if (db) {
            try {
              const q = query(
                collection(db, "tables", "1", "names"),
                orderBy("timestamp")
              );

              console.log("üîÑ Setting up Firestore listener...");

              const unsubscribe = onSnapshot(
                q,
                (snapshot) => {
                  console.log("üì° Firestore snapshot received:", {
                    size: snapshot.size,
                    empty: snapshot.empty,
                    metadata: snapshot.metadata,
                  });

                  document.getElementById("last-update").textContent =
                    new Date().toLocaleTimeString();
                  document.getElementById("table1-count").textContent =
                    snapshot.size;

                  // Clear existing names
                  namesContainer.innerHTML = "";

                  if (!snapshot.empty) {
                    console.log("üìã Processing names:");
                    snapshot.forEach((doc, index) => {
                      const data = doc.data();
                      console.log(
                        `  ${index + 1}. Document ID: ${doc.id}`,
                        data
                      );

                      const p = document.createElement("p");
                      p.textContent = data.name || "Unknown";
                      namesContainer.appendChild(p);
                    });
                  } else {
                    console.log("üìã No documents found in subcollection");
                    const p = document.createElement("p");
                    p.textContent = "No one here yet";
                    p.style.fontStyle = "italic";
                    p.style.opacity = "0.7";
                    namesContainer.appendChild(p);
                  }

                  const count = snapshot.size;
                  tableData[1] = count > MAX_OCCUPANCY ? MAX_OCCUPANCY : count;
                  document.getElementById("table-1-occupancy").textContent =
                    tableData[1];
                  updateTableColor(div, tableData[1]);

                  // Adjust height based on content
                  const baseHeight = 80;
                  const nameHeight = Math.max(count, 1) * 20;
                  div.style.height = `${baseHeight + nameHeight}px`;

                  updateProgressBar();

                  if (tableData[1] >= MAX_OCCUPANCY) {
                    console.log(
                      "‚ö†Ô∏è Table 1 is full. No more IDs can be added."
                    );
                  }
                },
                (error) => {
                  console.error("‚ùå Firestore listener error:", error);
                  document.getElementById("firebase-status").textContent =
                    "Error: " + error.message;

                  // Show error in names container
                  namesContainer.innerHTML = `<p style="color: red; font-size: 10px;">Error: ${error.message}</p>`;
                }
              );
            } catch (error) {
              console.error("‚ùå Error setting up Firestore listener:", error);
              namesContainer.innerHTML = `<p style="color: red; font-size: 10px;">Setup Error: ${error.message}</p>`;
            }
          } else {
            namesContainer.innerHTML = `<p style="color: orange; font-size: 10px;">Firebase not connected</p>`;
          }
        } else {
          // Tables 2-10: manual click
          div.innerHTML = `<strong>Table ${i}</strong><br>Occupancy: 0/${MAX_OCCUPANCY}`;
          div.style.backgroundColor = "lightgreen";
        }

        tablesContainer.appendChild(div);
      }

      function updateTableColor(div, occupancy) {
        if (occupancy === 0) {
          div.style.backgroundColor = "lightgreen";
        } else {
          const pct = (occupancy / MAX_OCCUPANCY) * 100;
          div.style.backgroundColor = getGradientColor(pct);
        }
      }

      function updateProgressBar() {
        const totalOccupancy = Object.values(tableData).reduce(
          (a, b) => a + b,
          0
        );
        const pct = (totalOccupancy / MAX_CAPACITY) * 100;
        progressBar.style.width = `${pct}%`;
        progressText.textContent = `${Math.round(pct)}% Occupancy`;
        progressBar.style.backgroundColor = getGradientColor(pct);
      }

      // Click handler for tables 2-10 only
      tablesContainer.addEventListener("click", (e) => {
        const div = e.target.closest(".table-box");
        if (!div) return;
        const tableId = div.id.split("-")[1];
        if (tableId === "1") return; // Disable click for table 1

        let occupancy = tableData[tableId];
        occupancy = (occupancy + 1) % (MAX_OCCUPANCY + 1);
        tableData[tableId] = occupancy;
        div.innerHTML = `<strong>Table ${tableId}</strong><br>Occupancy: ${occupancy}/${MAX_OCCUPANCY}`;
        updateTableColor(div, occupancy);
        updateProgressBar();
      });

      // Test function to add sample data (for debugging)
      window.testAddName = function () {
        if (db) {
          console.log("üß™ Adding test name...");
          // This would normally be done by your Python script
          // Just for testing the display
        } else {
          console.log("‚ùå Database not connected");
        }
      };
    </script>
  </body>
</html>
